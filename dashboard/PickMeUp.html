<!DOCTYPE html>
<html>

<head data-gwd-animation-mode="quickMode">
    <meta charset='utf-8' />
    <meta name="generator" content="Google Web Designer 1.4.2.0915">

    <title>PickMeUp Dashboard</title>

    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <style type="text/css">
        html, body {
        width: 100%;
        height: 100%;
        margin: 0px;
        }
        body {
        -webkit-transform: perspective(1400px) matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
        -webkit-transform-style: preserve-3d;
        background-color: transparent;
        }
        .gwd-img-47wf {
        position: absolute;
        left: 37px;
        top: 12px;
        }
        .gwd-img-1rko {
        position: absolute;
        left: 610px;
        top: 47px;
        }
        .gwd-img-1p4q {
        position: absolute;
        left: 70.5px;
        top: 294.5px;
        }
        .gwd-img-19jd {
        position: absolute;
        left: 701px;
        top: 292.5px;
        }
        .timeline {
        position: absolute;
        width: 90%;
        margin:0 auto;
        top: 450.5px;
        }
        .gwd-div-1n6o {
        position: absolute;
        font-family: 'Times New Roman';
        text-align: left;
        color: rgb(0, 0, 0);
        font-size: 60px;
        left: 122px;
        top: 359px;
        }
        .gwd-div-1394 {
        left: 744.5px;
        top: 359px;
        }
        .gwd-div-bh29 {
        position: absolute;
        width: 298px;
        height: 69px;
        left: 291px;
        top: 359px;
        font-family: 'Times New Roman';
        text-align: left;
        color: rgb(0, 0, 0);
        }

    </style>


    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">

      google.load("visualization", "1", {packages:["timeline"]});
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var scan = JSON.parse('{{ today_events|safe }}');
        //  console.log('Requests scanned ' + JSON.stringify(scan));

        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'Location_Type' });
        dataTable.addColumn({ type: 'string', id: 'Name' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });

        /*
        dataTable.addRows([
        [ 'Magnolia Room', 'Beginning JavaScript',       new Date(0,0,0,12,0,0),  new Date(0,0,0,13,30,0) ],
        [ 'Magnolia Room', 'Intermediate JavaScript',    new Date(0,0,0,14,0,0),  new Date(0,0,0,15,30,0) ],
        [ 'Magnolia Room', 'Advanced JavaScript',        new Date(0,0,0,16,0,0),  new Date(0,0,0,17,30,0) ],
        [ 'Willow Room',   'Beginning Google Charts',    new Date(0,0,0,12,30,0), new Date(0,0,0,14,0,0) ],
        [ 'Willow Room',   'Intermediate Google Charts', new Date(0,0,0,14,30,0), new Date(0,0,0,16,0,0) ],
        [ 'Willow Room',   'Advanced Google Charts',     new Date(0,0,0,16,30,0), new Date(0,0,0,18,0,0) ]]);
        */

        var today = new Date()
        var dd = today.getDate();
        var mm = today.getMonth(); //January is 0!
        var yyyy = today.getFullYear();

        for (loc in scan) {
            subdict = scan[loc]
            console.log("subdict -> " + JSON.stringify(subdict));
            for (property in subdict) {
                start_end_array = subdict[property]
                //console.log(property + " -> " + start_end_array);
                dataTable.addRow([property, '', new Date(yyyy,mm,dd,0,0,0), new Date(yyyy,mm,dd,0,0,0)])
                dataTable.addRow([property, '', new Date(yyyy,mm,dd,23,59,59), new Date(yyyy,mm,dd,23,59,59)])
                for (var i=0; i<start_end_array.length; i++) {
                    start_end = start_end_array[i];
                    //console.log(start_end + ' -> ' + new Date(start_end[0]) + "-" + new Date(start_end[1]));
                    dataTable.addRow([property, '', new Date(start_end[0]), new Date(start_end[1])])
                }
            }
         }

        var options = {
            hAxis: {
                format: 'HH:mm',
                viewWindow:{
                    min: new Date(yyyy,mm,dd,6),
                    max: new Date(yyyy,mm,dd,23)
                }
            }
        };

        chart.draw(dataTable, options);
      }
    </script>

</head>

<body>

<script>

    var setupChannel = function(token) {
      var channel = new goog.appengine.Channel(token);
      var socket = channel.open();
      socket.onopen = function() {
        console.log('Channel opened!');
      };
      socket.onmessage = function(msg) {
        console.log('Received message!');
        var scan = JSON.parse(msg.data.toString());
        var peopleInTrento = scan.passenger.trento
        var peopleInPovo = scan.passenger.povo
        console.log("received message: " + msg.data);
        document.getElementById("p_tn").innerHTML=peopleInTrento;
        document.getElementById("p_pv").innerHTML=peopleInPovo;
        document.getElementById("log_text").innerHTML=msg.data;
      }
      socket.onerror = function(err) {
        // reconnect on timeout
        if (err.code == 401) {
          console.log('Token expired, reconnecting!');
          reconnect();
        }
        else {
          console.log('CHANNEL ERROR!');
        }
      };
      socket.onclose = function() {
        console.log('channel closed');
      };
    };

    // get channel token from the backend and connect
    var reconnect = function() {
      var tokenReq = new XMLHttpRequest();
      tokenReq.onload = function () {
        var token = JSON.parse(this.responseText).token;
        setupChannel(token);
      };
      tokenReq.open("get", "/notify_token", true);
      tokenReq.send();
    };

    setupChannel('{{token}}');

</script>

<img src="dashboard/assets/image.png" class="gwd-img-47wf">
<img src="dashboard/assets/image_3.png" class="gwd-img-1rko">
<img src="dashboard/assets/image_4.png" class="gwd-img-1p4q">
<img src="dashboard/assets/image_5.png" class="gwd-img-19jd">

<div id="p_tn" class="gwd-div-1n6o">{{ passenger['trento'] }}</div>
<div id="p_pv" class="gwd-div-1n6o gwd-div-1394">{{ passenger['povo'] }}</div>
<div id="log_text" class="gwd-div-bh29">passengers: {{ passenger }} PV-TN: {{ ridesPovoToTrento }} TN-PV: {{
    ridesTrentoToPovo }}
</div>


<!-- MAIN CONTENT -->

<div id="timeline_wrap" class="timeline">
    <div id="timeline" style="height: 350px;"></div>
</div>

</body>

</html>